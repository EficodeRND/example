dbsetup:
  layers:
    - !Ref CommonLambdaLayer
    - !Ref AppLambdaLayer
  handler: lambdas/migrations/db_setup.handler
  timeout: 120
  package:
    patterns:
      - 'lambdas/migrations/db_setup.py'
      - '!**/__pycache__/**'
  environment:
    DB_MASTER_SECRET_ARN:
      Ref: DBMasterSecret
    DB_APP_SECRET_ARN:
      Ref: DBAppSecret
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - secretsmanager:GetSecretValue
      Resource: 
        - !Ref DBMasterSecret
        - !Ref DBAppSecret

dbmigrations:
  layers:
    - !Ref CommonLambdaLayer
    - !Ref AppLambdaLayer
    - !Ref MigrationsLambdaLayer
  handler: lambdas/migrations/migrations.handler
  package:
    patterns:
      - 'lambdas/migrations/**'
      - 'lambdas/models.py'
      - '!**/__pycache__/**'
      - '!lambdas/migrations/db_setup.py'
  environment:
    DB_APP_SECRET_ARN:
      Ref: DBAppSecret
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - secretsmanager:GetSecretValue
      Resource: !Ref DBAppSecret

users:
  layers:
    - !Ref CommonLambdaLayer
    - !Ref AppLambdaLayer
  handler: lambdas/users.handler
  package:
    patterns:
      - 'lambdas/users.py'
      - 'lambdas/models.py'
      - 'lambdas/dao/**'
      - 'lambdas/services/**'
      - 'lambdas/utils/**'
      - '!**/__pycache__/**'
  environment:
    DB_APP_SECRET_ARN:
      Ref: DBAppSecret
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - secretsmanager:GetSecretValue
      Resource: !Ref DBAppSecret

cognitoHooks:
  handler: lambdas/cognito_hooks.handler
  layers:
    - !Ref CommonLambdaLayer
    - !Ref AppLambdaLayer
  package:
    patterns:
      - 'lambdas/models.py'
      - 'lambdas/dao/**'
      - 'lambdas/services/**'
      - 'lambdas/utils/**'
      - 'lambdas/cognito_hooks.py'
      - '!**/__pycache__/**'
  events:
    - cognitoUserPool:
        pool: UserPool
        trigger: PostConfirmation
    - cognitoUserPool:
        pool: UserPool
        trigger: PostAuthentication
    - cognitoUserPool:
        pool: UserPool
        trigger: PreTokenGeneration
  environment:
    DB_APP_SECRET_ARN:
      Ref: DBAppSecret
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - secretsmanager:GetSecretValue
      Resource: !Ref DBAppSecret
